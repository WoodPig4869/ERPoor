import{k as ue,c as ce,h as me,l as ve,d as X,r as g,Z as fe,o as Y,R as q,S as v,U as o,f as t,a6 as w,$ as b,a0 as e,a1 as A,a2 as pe,a3 as S,ah as be,a4 as Z,a5 as M,_ as G,O as ge,ag as _e,ab as E,X as _,W as p,Y as d,V as T,F as z,ac as ye,P as H,ai as xe}from "./index-CLxRvZYn.js";import{f as D,h as he}from "./QSelect-BUHZvF4Q.js";import{b as Q,a as O,Q as we}from "./QTable-B-UTUnxZ.js";import{C as W}from "./ClosePopup-BHTxnMEi.js";import{u as J}from "./use-quasar-DkPXY9po.js";import{api as L}from "./axios-DLpAuOl3.js";import{e as R,u as Ve}from "./MainLayout-store-C26opbpP.js";import{Q as ke}from "./QForm-BGxHd8hi.js";import{_ as qe}from "./_plugin-vue_export-helper-DlAUqK2U.js";const Se=ue({name:"QTr",props:{props:Object,noHover:Boolean},setup(V, {slots:C}){const y=ce(()=>"q-tr"+(V.props===void 0||V.props.header===!0?"":" "+V.props.__trClass)+(V.noHover===!0?" q-tr--no-hover":""));return()=>me("tr",{style:V.props?.__trStyle,class:y.value},ve(C.default))}}),Pe=X({__name:"addNewProductForm",props:{modelValue:{type:[Boolean,null],default:!1},modelModifiers:{}},emits:["update:modelValue"],setup(V){const C=J(),y=g(),k=g(!1),x=fe(V,"modelValue"),r=g({name:"",category:"",unit:"",expiry_alert_days:30,min_stock:10,description:"",enabled:!0,price:0});function P(){r.value={name:"",category:"",unit:"件",expiry_alert_days:30,min_stock:10,description:"",enabled:!0,price:0},ge(()=>{y.value?.resetValidation()})}async function f(){if(await y.value?.validate?.()){k.value=!0;try{await L.post("/inventory/addProduct",r.value),C.notify({color:"positive",message:"成功新增產品！",icon:"check",position:"top"}),x.value=!1,P(),R.emit("product-added")}catch(i){console.error("新增產品失敗",i),C.notify({color:"negative",message:"新增失敗，請檢查資料或稍後再試",icon:"error"})}finally{k.value=!1}}}return Y(()=>{P()}),(I, i)=>(v(),q(G,{modelValue:x.value,"onUpdate:modelValue":i[8]||(i[8]= s=>x.value=s)},{default:o(()=>[t(w,{class:"q-pa-md shadow-4",style:{"min-width":"500px","max-width":"90vw"}},{default:o(()=>[t(b,null,{default:o(()=>i[9]||(i[9]=[e("div",{class:"text-h6"},"新增產品",-1)])),_:1,__:[9]}),t(A),t(b,null,{default:o(()=>[t(ke,{onSubmit:pe(f,["prevent"]),class:"q-gutter-sm",ref_key:"formRef",ref:y,loading:k.value},{default:o(()=>[t(S,{modelValue:r.value.name,"onUpdate:modelValue":i[0]||(i[0]= s=>r.value.name=s),label:"商品名稱",dense:"",filled:"",rules:[s=>!!s||"必填"]},null,8,["modelValue","rules"]),t(S,{modelValue:r.value.category,"onUpdate:modelValue":i[1]||(i[1]= s=>r.value.category=s),label:"分類",dense:"",filled:""},null,8,["modelValue"]),t(S,{modelValue:r.value.unit,"onUpdate:modelValue":i[2]||(i[2]= s=>r.value.unit=s),label:"單位（如:瓶、包）",dense:"",filled:"",rules:[s=>!!s||"必填"]},null,8,["modelValue","rules"]),t(S,{modelValue:r.value.expiry_alert_days,"onUpdate:modelValue":i[3]||(i[3]= s=>r.value.expiry_alert_days=s),modelModifiers:{number:!0},label:"到期預警天數",type:"number",dense:"",filled:"",rules:[s=>s>=0||"必須 >= 0"]},null,8,["modelValue","rules"]),t(S,{modelValue:r.value.min_stock,"onUpdate:modelValue":i[4]||(i[4]= s=>r.value.min_stock=s),modelModifiers:{number:!0},label:"告警庫存量",type:"number",dense:"",filled:"",rules:[s=>s>=0||"必須 >= 0"]},null,8,["modelValue","rules"]),t(S,{modelValue:r.value.price,"onUpdate:modelValue":i[5]||(i[5]= s=>r.value.price=s),label:"價格",type:"number",dense:"",filled:"",rules:[s=>s>=0||"必須 >= 0"]},null,8,["modelValue","rules"]),t(S,{modelValue:r.value.description,"onUpdate:modelValue":i[6]||(i[6]= s=>r.value.description=s),label:"商品描述",type:"textarea",dense:"",filled:"",autogrow:""},null,8,["modelValue"]),t(be,{modelValue:r.value.enabled,"onUpdate:modelValue":i[7]||(i[7]= s=>r.value.enabled=s),label:"是否啟用"},null,8,["modelValue"])]),_:1},8,["loading"])]),_:1}),t(Z,{align:"right"},{default:o(()=>[t(M,{flat:"",label:"清空",color:"secondary",onClick:P}),t(M,{label:"送出",color:"primary",loading:k.value,onClick:f},null,8,["loading"])]),_:1})]),_:1})]),_:1},8,["modelValue"]))}}),De={class:"q-pa-md"},Ce={class:"page-header"},Qe={class:"row items-center justify-between q-mb-md"},Me={class:"col-auto"},Be={class:"text-h4 text-weight-bold text-primary"},Ee={class:"col-auto"},Te={class:"row q-col-gutter-md q-mb-md"},Ue={class:"col-xs-12 col-sm-6 col-md-3"},$e={class:"row items-center q-gutter-md"},ze={class:"stat-value text-blue-8 q-mt-xs"},Ie={class:"col-xs-12 col-sm-6 col-md-3"},Ne={class:"row items-center q-gutter-md"},Fe={class:"stat-value text-green-8 q-mt-xs"},Ae={class:"col-xs-12 col-sm-6 col-md-3"},Le={class:"row items-center q-gutter-md"},Re={class:"stat-value text-red-8 q-mt-xs"},je={class:"col-xs-12 col-sm-6 col-md-3"},He={class:"row items-center q-gutter-md"},Oe={class:"stat-value text-purple-8 q-mt-xs"},We={class:"row justify-between items-center q-mb-md"},Xe={class:"col-12 col-md-2"},Ye={class:"full-width row flex-center text-accent q-pa-lg"},Ze={key:0},Ge={class:"row q-col-gutter-md"},Je={class:"col-12 col-md-6"},Ke={class:"text-subtitle1 text-weight-bold text-primary q-mb-md"},et={class:"info-grid"},tt={class:"info-item"},lt={class:"info-value text-weight-medium"},at={class:"info-item"},ot={class:"info-value"},st={class:"info-item"},it={class:"info-value"},nt={class:"info-item"},rt={class:"info-value text-green-8 text-weight-bold"},dt={class:"col-12 col-md-6"},ut={class:"text-subtitle1 text-weight-bold text-primary q-mb-md"},ct={class:"info-grid"},mt={class:"info-item"},vt={class:"info-value text-weight-bold"},ft={class:"info-item"},pt={class:"info-value text-green-8 text-weight-bold"},bt={class:"info-item"},gt={class:"info-value text-red-8 text-weight-bold"},_t={class:"info-item"},yt={class:"info-value"},xt={class:"col-12"},ht={class:"text-subtitle1 text-weight-bold text-primary q-mb-md"},wt={class:"text-weight-medium"},Vt={class:"text-weight-medium text-green-8"},kt={class:"text-weight-medium"},qt=X({__name:"InventoryPage",setup(V){const C=Ve(),y=J(),k=g(""),x=g([]),r=g(!1),P=g(!1),f=_e({totalProducts:0,availableStock:0,expiredStock:0,totalValue:0});function I(){P.value=!0}const i=g(!1),s=g(null),N=g([]),F=g(!1);async function K(n){const l=x.value.find(a=>a.productId===n);l&&(s.value=l,i.value=!0,await ee(n))}async function ee(n){r.value=!0;try{F.value=!0;const l=await L.get(`/inventory/${n}`),u=x.value.find(m=>m.productId===n)?.price||0;N.value=l.data.map(m=>({...m,salePrice:u}))}catch(l){y.notify({color:"negative",message:"獲取批次資料失敗",icon:"report_problem",position:"top"}),console.error("Error fetching product batches:",l)}finally{F.value=!1,r.value=!1}}async function B(){try{r.value=!0;const n=await L.get("/inventory/productInventoryView");x.value=n.data.map(l=>({...l,nearExpiry:U(l.nearestExpiryDate)})),se(x.value)}catch(n){y.notify({color:"negative",message:"獲取庫存資料失敗",icon:"report_problem",position:"top"}),console.error("Error fetching inventory data:",n)}finally{r.value=!1}}Y(()=>{C.resetInventoryBadge(),R.on("productBatch-added",()=>{B()}),R.on("product-added",()=>{B()}),B()});function U(n){const l=new Date,u=new Date(n).getTime()-l.getTime(),m=Math.ceil(u/(1e3*60*60*24));return m<=7&&m>=0}const te=[{name:"name",label:"品名",field:"name",align:"left",sortable:!0},{name:"availableStock",label:"有效庫存",field:"availableStock",align:"right",sortable:!0},{name:"unit",label:"單位",field:"unit",align:"left"},{name:"category",label:"類別",field:"category",align:"left"},{name:"price",label:"售價",field:"price",align:"left",sortable:!0,format: n=>`$${n}`},{name:"nearestExpiryDate",label:"最近到期日",field:"nearestExpiryDate",align:"left",sortable:!0}],le=[{name:"batchCode",label:"批次編號",field:"batchCode",align:"left",sortable:!0},{name:"quantity",label:"數量",field:"quantity",align:"center",sortable:!0},{name:"purchasePrice",label:"進價",field:"purchasePrice",align:"left",sortable:!0},{name:"expirationDate",label:"到期日",field:"expirationDate",align:"left",sortable:!0}];function ae(n){return new Date(n).toLocaleDateString("zh-TW",{year:"numeric",month:"2-digit",day:"2-digit"})}function oe(n){return Math.floor(n).toLocaleString()}function $(n, l, a, u){const m=performance.now(),c=l-n,h= ie=>{const ne=ie-m,j=Math.min(ne/a,1),re=1-Math.pow(1-j,4),de=n+c*re;u(de),j<1&&requestAnimationFrame(h)};requestAnimationFrame(h)}function se(n){const l=n.length,a=n.reduce((c, h)=>c+h.availableStock,0),u=n.reduce((c, h)=>c+h.expiredStock,0),m=n.reduce((c, h)=>c+h.availableStock*h.price,0);setTimeout(()=>{$(0,l,1e3, c=>{f.totalProducts=c}),$(0,a,1200, c=>{f.availableStock=c}),$(0,u,1400, c=>{f.expiredStock=c}),$(0,m,1600, c=>{f.totalValue=c})},300)}return(n, l)=>(v(),E(z,null,[e("div",De,[e("div",Ce,[e("div",Qe,[e("div",Me,[e("div",Be,[t(p,{name:"inventory",class:"q-mr-sm"}),l[3]||(l[3]=_(" 庫存管理 "))]),l[4]||(l[4]=e("div",{class:"text-subtitle1 text-grey-6 q-mt-xs"},"管理和追蹤所有庫存商品",-1))]),e("div",Ee,[t(M,{color:"primary",icon:"add",label:"加入新商品",unelevated:"",onClick:I,class:"q-px-lg"})])])]),e("div",Te,[e("div",Ue,[t(w,{class:"stat-card bg-blue-1",flat:"",bordered:""},{default:o(()=>[t(b,null,{default:o(()=>[e("div",$e,[t(p,{name:"inventory",size:"md",class:"text-blue-7"}),e("div",null,[l[5]||(l[5]=e("div",{class:"text-subtitle2 text-grey-7"},"商品總數",-1)),e("div",ze,d(Math.floor(f.totalProducts)),1)])])]),_:1})]),_:1})]),e("div",Ie,[t(w,{class:"stat-card bg-green-1",flat:"",bordered:""},{default:o(()=>[t(b,null,{default:o(()=>[e("div",Ne,[t(p,{name:"check_circle",size:"md",class:"text-green-7"}),e("div",null,[l[6]||(l[6]=e("div",{class:"text-subtitle2 text-grey-7"},"有效庫存",-1)),e("div",Fe,d(Math.floor(f.availableStock)),1)])])]),_:1})]),_:1})]),e("div",Ae,[t(w,{class:"stat-card bg-red-1",flat:"",bordered:""},{default:o(()=>[t(b,null,{default:o(()=>[e("div",Le,[t(p,{name:"warning",size:"md",class:"text-red-7"}),e("div",null,[l[7]||(l[7]=e("div",{class:"text-subtitle2 text-grey-7"},"過期庫存",-1)),e("div",Re,d(Math.floor(f.expiredStock)),1)])])]),_:1})]),_:1})]),e("div",je,[t(w,{class:"stat-card bg-purple-1",flat:"",bordered:""},{default:o(()=>[t(b,null,{default:o(()=>[e("div",He,[t(p,{name:"attach_money",size:"md",class:"text-purple-7"}),e("div",null,[l[8]||(l[8]=e("div",{class:"text-subtitle2 text-grey-7"},"庫存價值",-1)),e("div",Oe," $"+d(oe(f.totalValue)),1)])])]),_:1})]),_:1})])]),e("div",We,[t(S,{filled:"",modelValue:k.value,"onUpdate:modelValue":l[0]||(l[0]= a=>k.value=a),label:"搜尋庫存",class:"col-grow q-mr-md",debounce:"300",placeholder:"輸入品名或庫別...",clearable:"",dense:""},{append:o(()=>[t(p,{name:"search"})]),_:1},8,["modelValue"]),e("div",Xe,[t(M,{color:"primary",icon:"refresh",label:"重新整理",onClick:B,loading:r.value,unelevated:"",class:"full-width"},null,8,["loading"])])]),t(O,{title:"📦 庫存清單",rows:x.value,columns:te,"row-key":"productId",loading:r.value,filter:k.value,"rows-per-page-options":[20,35,50,0],"table-header-class":"bg-light-blue-2 text-weight-bold","table-header-style":"color: #5a6c7d",flat:"",bordered:"",separator:"cell",class:"rounded-borders"},{body:o(a=>[t(Se,{props:a,onClick: u=>K(a.row.productId),class:"cursor-pointer"},{default:o(()=>[(v(!0),E(z,null,ye(a.cols, u=>(v(),q(Q,{key:u.name,props:a},{default:o(()=>[u.name==="productName"?(v(),q(D,{key:0,flat:"",dense:"",padding:"xs",label:a.row.productName,class:"text-subtitle1"},null,8,["label"])):u.name==="stock"?(v(),q(D,{key:1,color:a.row.stock<10?"red-4":"green-4","text-color":"white",class:"text-weight-bold",dense:""},{default:o(()=>[_(d(a.row.stock),1)]),_:2},1032,["color"])):u.name==="nearestExpiryDate"?(v(),E(z,{key:2},[_(d(a.row.nearestExpiryDate)+" ",1),U(a.row.nearestExpiryDate)?(v(),q(D,{key:0,color:"orange-5","text-color":"white",icon:"warning",label:"即將過期",size:"sm",class:"q-mr-sm"})):T("",!0)],64)):(v(),E(z,{key:3},[_(d(u.value),1)],64))]),_:2},1032,["props"]))),128))]),_:2},1032,["props","onClick"])]),"no-data":o(({icon:a,message:u,filter:m})=>[e("div",Ye,[t(p,{size:"2em",name:a},null,8,["name"]),e("span",null,d(u),1),m?(v(),E("span",Ze,' 過濾條件: "'+d(m)+'" ',1)):T("",!0)])]),_:1},8,["rows","loading","filter"])]),t(G,{modelValue:i.value,"onUpdate:modelValue":l[1]||(l[1]= a=>i.value=a),maximized:xe(y).screen.lt.md},{default:o(()=>[t(w,{class:"product-batch-details-card",style:{"min-width":"800px","max-width":"90vw","max-height":"90vh"}},{default:o(()=>[t(b,{class:"row items-center q-pb-none bg-primary text-white"},{default:o(()=>[t(p,{name:"inventory",size:"md",class:"q-mr-sm"}),l[9]||(l[9]=e("div",{class:"text-h6"},"產品批次詳情",-1)),t(we),H(t(M,{icon:"close",flat:"",round:"",dense:"",color:"white"},null,512),[[W]])]),_:1,__:[9]}),t(A),s.value?(v(),q(b,{key:0,class:"scroll",style:{"max-height":"70vh"}},{default:o(()=>[e("div",Ge,[e("div",Je,[t(w,{flat:"",bordered:"",class:"info-card"},{default:o(()=>[t(b,null,{default:o(()=>[e("div",Ke,[t(p,{name:"inventory",class:"q-mr-sm"}),l[10]||(l[10]=_(" 產品資訊 "))]),e("div",et,[e("div",tt,[l[11]||(l[11]=e("div",{class:"info-label"},"產品名稱",-1)),e("div",lt,d(s.value.name),1)]),e("div",at,[l[12]||(l[12]=e("div",{class:"info-label"},"類別",-1)),e("div",ot,d(s.value.category),1)]),e("div",st,[l[13]||(l[13]=e("div",{class:"info-label"},"單位",-1)),e("div",it,d(s.value.unit),1)]),e("div",nt,[l[14]||(l[14]=e("div",{class:"info-label"},"售價",-1)),e("div",rt," $"+d(s.value.price),1)])])]),_:1})]),_:1})]),e("div",dt,[t(w,{flat:"",bordered:"",class:"info-card"},{default:o(()=>[t(b,null,{default:o(()=>[e("div",ut,[t(p,{name:"assessment",class:"q-mr-sm"}),l[15]||(l[15]=_(" 庫存統計 "))]),e("div",ct,[e("div",mt,[l[16]||(l[16]=e("div",{class:"info-label"},"總庫存",-1)),e("div",vt,d(s.value.totalStock),1)]),e("div",ft,[l[17]||(l[17]=e("div",{class:"info-label"},"有效庫存",-1)),e("div",pt,d(s.value.availableStock),1)]),e("div",bt,[l[18]||(l[18]=e("div",{class:"info-label"},"過期庫存",-1)),e("div",gt,d(s.value.expiredStock),1)]),e("div",_t,[l[19]||(l[19]=e("div",{class:"info-label"},"最近到期日",-1)),e("div",yt,[_(d(s.value.nearestExpiryDate)+" ",1),U(s.value.nearestExpiryDate)?(v(),q(D,{key:0,color:"orange-5","text-color":"white",icon:"warning",label:"即將過期",size:"sm",class:"q-ml-sm"})):T("",!0)])])])]),_:1})]),_:1})]),e("div",xt,[t(w,{flat:"",bordered:"",class:"batches-card"},{default:o(()=>[t(b,null,{default:o(()=>[e("div",ht,[t(p,{name:"layers",class:"q-mr-sm"}),l[20]||(l[20]=_(" 批次清單 ")),t(D,{color:"grey-4","text-color":"grey-8",dense:"",label:`共 ${N.value.length} 批次`,class:"q-ml-sm"},null,8,["label"])]),t(O,{rows:N.value,columns:le,"row-key":"batchId",loading:F.value,flat:"",dense:"","hide-pagination":"",pagination:{rowsPerPage:0},class:"detail-batches-table"},{"body-cell-batchCode":o(a=>[t(Q,{props:a},{default:o(()=>[t(D,{color:"blue-2","text-color":"blue-8",dense:""},{default:o(()=>[_(d(a.value),1)]),_:2},1024)]),_:2},1032,["props"])]),"body-cell-quantity":o(a=>[t(Q,{props:a},{default:o(()=>[t(he,{color:a.value>0?"green-4":"red-4","text-color":"white",label:a.value,class:"q-px-sm"},null,8,["color","label"])]),_:2},1032,["props"])]),"body-cell-purchasePrice":o(a=>[t(Q,{props:a},{default:o(()=>[e("div",wt,"$"+d(a.value),1)]),_:2},1032,["props"])]),"body-cell-salePrice":o(a=>[t(Q,{props:a},{default:o(()=>[e("div",Vt,"$"+d(a.value),1)]),_:2},1032,["props"])]),"body-cell-expirationDate":o(a=>[t(Q,{props:a},{default:o(()=>[e("div",kt,[_(d(ae(a.value))+" ",1),U(a.value)?(v(),q(D,{key:0,color:"orange-5","text-color":"white",icon:"warning",label:"即將過期",size:"sm",class:"q-ml-sm"})):T("",!0)])]),_:2},1032,["props"])]),_:1},8,["rows","loading"])]),_:1})]),_:1})])])]),_:1})):T("",!0),t(A),t(Z,{align:"right",class:"bg-grey-1"},{default:o(()=>[H(t(M,{color:"primary",icon:"close",label:"關閉",flat:""},null,512),[[W]])]),_:1})]),_:1})]),_:1},8,["modelValue","maximized"]),t(Pe,{modelValue:P.value,"onUpdate:modelValue":l[2]||(l[2]= a=>P.value=a),onProductAdded:B},null,8,["modelValue"])],64))}}),Ut=qe(qt,[["__scopeId","data-v-201866b0"]]);export{Ut as default};
